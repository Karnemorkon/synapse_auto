# Автоматизоване встановлення Matrix Synapse за допомогою Docker

Скрипт `synapse_auto.sh` призначений для спрощення процесу розгортання сервера Matrix Synapse та пов'язаних з ним служб (таких як Element Web, мости до інших месенджерів, Portainer) на сервері під управлінням Debian або сумісних ОС. Встановлення відбувається за допомогою Docker та Docker Compose, що забезпечує ізоляцію та легкість управління компонентами.

## Можливості скрипта

*   **Інтерактивне налаштування:** Скрипт проводить користувача через процес налаштування, ставлячи питання про ключові параметри (домен, паролі, опції федерації, реєстрації тощо).
*   **Встановлення Synapse:** Розгортає останню версію Matrix Synapse з базою даних PostgreSQL.
*   **Встановлення Element Web:** Опціонально встановлює веб-клієнт Element.
*   **Мости до інших месенджерів:** Опціонально встановлює та налаштовує мости Mautrix для інтеграції з WhatsApp, Telegram, Signal, Discord.
*   **Portainer:** Опціонально встановлює Portainer для зручного управління Docker-контейнерами через веб-інтерфейс.
*   **Гнучкість доступу:** Дозволяє обрати спосіб доступу до сервера:
    *   **Cloudflare Tunnel:** Для приховування IP-адреси сервера та доступу через NAT.
    *   **Nginx Proxy Manager (NPM) / Let's Encrypt:** Передбачає, що користувач самостійно налаштує NPM для SSL-сертифікатів (скрипт не встановлює NPM, лише враховує його використання).
    *   **Прямий доступ:** Якщо жоден з вищевказаних методів не обрано, сервіси будуть доступні через прокинуті порти (потребує налаштування фаєрволу).
*   **Автоматичне встановлення залежностей:** Встановлює Docker Engine та Docker Compose, якщо вони відсутні.
*   **Генерація конфігурацій:** Автоматично генерує базові конфігураційні файли для Synapse та мостів.
*   **Детальне логування:** Весь процес встановлення, включаючи вивід команд, записується у файл логу для діагностики.
*   **Режим оновлення:** Дозволяє оновити Docker образи існуючого встановлення.
*   **Безпека:** Встановлює рекомендовані права доступу до конфігураційних файлів.
*   **Рекомендації:** Надає інструкції щодо подальших кроків та резервного копіювання.

## Вимоги

*   Сервер під управлінням Debian (рекомендовано остання стабільна версія) або сумісної ОС (наприклад, Ubuntu).
*   Права `root` або можливість виконання команд через `sudo`.
*   **Рекомендовано використовувати на "чистому" сервері**, щоб уникнути конфліктів портів. Переконайтеся, що стандартні порти (80, 443), а також порти, що використовуються Synapse та іншими компонентами (8008, 8448, 9443, 8000, 8080 тощо), не зайняті іншими важливими службами.
*   Доступ до Інтернету для завантаження пакетів та Docker-образів.
*   Доменне ім'я, яке буде спрямоване на IP-адресу вашого сервера (особливо важливо для федерації та отримання SSL-сертифікатів).
*   (Опціонально) Акаунт Cloudflare та токен тунелю, якщо планується використання Cloudflare Tunnel.
*   (Опціонально) Встановлений та налаштований Nginx Proxy Manager, якщо планується його використання.



## Інструкція з використання

1.  **Завантажте скрипт:**
    Скопіюйте файл `synapse_auto.sh` на ваш сервер.

    ```bash
     sudo apt install curl
     curl -O https://raw.githubusercontent.com/Karnemorkon/synapse_auto/refs/heads/main/synapse_auto.sh
    ```

2.  **Надайте права на виконання:**
    ```bash
    chmod +x synapse_auto.sh
    ```

3.  **Запустіть скрипт:**
    Запускайте скрипт з правами `root` або через `sudo`.
    ```bash
    sudo ./synapse_auto.sh
    ```

4.  **Дотримуйтесь інструкцій майстра встановлення:**
    Скрипт поставить низку запитань для налаштування вашого сервера Matrix. Уважно читайте описи та вводьте необхідні дані.
    *   **Домен:** Ваш основний домен для сервера Matrix (наприклад, `yourdomain.com`).
    *   **Пароль для PostgreSQL:** Надійний пароль для користувача бази даних.
    *   **Інші опції:** Публічна реєстрація, федерація, встановлення Element, мостів, Portainer, спосіб доступу (Cloudflare Tunnel/NPM).

5.  **Процес встановлення:**
    Після збору інформації скрипт автоматично виконає наступні кроки:
    *   Встановлення Docker та Docker Compose (якщо потрібно).
    *   Створення структури директорій.
    *   Генерація конфігураційних файлів.
    *   Завантаження Docker-образів.
    *   Запуск Docker-контейнерів.
    *   Генерація реєстраційних файлів для мостів.

6.  **Завершення та наступні кроки:**
    Після завершення роботи скрипта на екрані з'являться інструкції щодо:
    *   Доступу до Portainer (якщо встановлено).
    *   Налаштування Cloudflare Tunnel (якщо обрано).
    *   Доступу до Synapse, Element Web, Synapse Admin.
    *   Управління мостами (зазвичай через команди в чаті Matrix).
    *   Створення першого адміністративного користувача Matrix.
    *   **Рекомендації щодо резервного копіювання.**

    Весь процес встановлення буде залоговано у файл `matrix_install_РРРР-ММ-ДД_ГГ-ХХ-СС.log` в директорії, з якої було запущено скрипт.

## Режим оновлення

Якщо у вас вже є встановлення, зроблене цим скриптом, ви можете запустити його знову. Скрипт виявить існуючу директорію `matrix` та запропонує:
*   **`update`**: Оновити існуюче встановлення. Цей режим завантажить останні версії Docker-образів та перезапустить стек.
    *   **Важливо:** Цей режим оновить лише Docker образи. Якщо в нових версіях програмного забезпечення змінився формат конфігураційних файлів, вам може знадобитися оновити їх вручну. Завжди робіть резервні копії перед оновленням!
*   **`new`**: Створити нове встановлення (потребуватиме видалення існуючої директорії `matrix`).

## Важливо

*   **Безпека:** Завжди використовуйте надійні паролі. Після встановлення перегляньте конфігураційні файли та налаштування безпеки вашого сервера.
*   **Фаєрвол:** Якщо ви не використовуєте Cloudflare Tunnel, переконайтеся, що необхідні порти відкриті у вашому фаєрволі (наприклад, 80, 443, 8008, 8448, а також 9443, 8000, 8080 для Portainer та Synapse Admin).
*   **Конфлікти портів:** Скрипт призначений для встановлення на сервер, де стандартні порти не зайняті критично важливими службами. Якщо у вас вже працюють веб-сервери або інші служби на портах 80/443, можуть виникнути конфлікти.
*   **Резервне копіювання:** Регулярно створюйте резервні копії даних вашого сервера, особливо директорій, вказаних у фінальних інструкціях скрипта.
*   **Документація:** Для більш глибокого налаштування Synapse, Element та мостів звертайтеся до їхньої офіційної документації.

## Повідомлення про проблеми

Якщо під час виконання скрипта виникають помилки, перевірте файл логу (`matrix_install_*.log`) для отримання детальної інформації. Ви також можете звернутися до спільноти Matrix або відповідних репозиторіїв програмного забезпечення за допомогою.
